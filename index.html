<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>No Pasa Nada Air Tracker</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<script src="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.js"></script>
<link href="https://api.mapbox.com/mapbox-gl-js/v3.3.0/mapbox-gl.css" rel="stylesheet" />
<style>
body { margin:0; padding:0; }
#map { position:absolute; top:0; bottom:0; width:100%; }
.marker {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    border: 2px solid white;
    background-color: red;
}
</style>
</head>
<body>
<div id="map"></div>

<script>
mapboxgl.accessToken = 'pk.eyJ1IjoiYnJpZ2h0cGl4ZWwyMDI0IiwiYSI6ImNtaThtbW9kYTBldGEybG9zYXFnZG93dzkifQ.lkI7df4o4LxpxkrtLtSIhw';

const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/streets-v12',
    center: [-100, 30],
    zoom: 6
});

let marker = null;
let lastPos = [0,0];

function waitForPlane() {
    const plane = window.geofs?.player?.aircraft;

    if (plane && plane.position?.lat && plane.position?.lon) {
        const startPos = [plane.position.lon, plane.position.lat];
        lastPos = [...startPos];

        // Create a custom HTML marker element
        const el = document.createElement('div');
        el.className = 'marker';
        el.style.backgroundColor = plane.position.alt > 5 ? 'red' : 'blue';

        marker = new mapboxgl.Marker(el).setLngLat(startPos).addTo(map);

        const popup = new mapboxgl.Popup({ offset: 25 });
        marker.setPopup(popup);
        map.setCenter(startPos);

        startTracking(el);
    } else {
        setTimeout(waitForPlane, 500);
    }
}

function startTracking(markerEl) {
    function animateMarker(newPos) {
        const frames = 10;
        const deltaLng = (newPos[0] - lastPos[0])/frames;
        const deltaLat = (newPos[1] - lastPos[1])/frames;
        let i=0;
        function step() {
            if(i>=frames) return;
            lastPos[0]+=deltaLng;
            lastPos[1]+=deltaLat;
            marker.setLngLat(lastPos);
            i++;
            requestAnimationFrame(step);
        }
        step();
    }

    function updatePlane() {
        const plane = window.geofs.player.aircraft;
        const lat = plane.position.lat;
        const lon = plane.position.lon;
        const alt = plane.position.alt;
        const type = plane.name || "Unknown";

        // Update marker color based on grounded/flying
        markerEl.style.backgroundColor = alt > 5 ? 'red' : 'blue';

        animateMarker([lon, lat]);
        map.setCenter([lon, lat]);
        marker.getPopup().setHTML(`<b>Plane:</b> ${type}<br><b>Altitude:</b> ${Math.round(alt)} ft`);
    }

    setInterval(updatePlane, 2000);
}

waitForPlane();
</script>
</body>
</html>
